function addLine(t,e){var n=getCoords();if(t)var o=[t.x,t.y,t.x,t.y];else var o=[n.x,n.y,n.x,n.y];var i=new Konva.Line({points:o,stroke:last_color,strokeWidth:5,lineCap:"round",lineJoin:"round"});i.on("mouseleave",function(){layer.setZIndex(999999),document.body.style.cursor="default";for(var t=lines[this.getAttr("count")].points,e=t.length,n=0;e>n;n++)t[n].setAttrs({fill:"transparent",stroke:"transparent"});layer.draw()}),i.on("mouseenter",function(){layer.setZIndex(999999),document.body.style.cursor="crosshair";for(var t=lines[this.getAttr("count")].points,e=t.length,n=0;e>n;n++)t[n].setAttrs({fill:"white",stroke:"black"});layer.draw()}),i.on("mousedown touchstart",function(t){if(layer.setZIndex(999999),2==t.evt.button)return line_number=this.getAttr("count"),void lineMenu();for(var e=getCoords(),n=lines[this.getAttr("count")].line.getAttrs("point").points,o=!1,i=0;i<n.length-1;i+=2){var r=this.getAttrs("point").points[i+0],s=this.getAttrs("point").points[i+1],l=this.getAttrs("point").points[i+2],a=this.getAttrs("point").points[i+3],u=e.x,c=e.y,h=l-r,d=a-s,p=u-r,A=c-s,v=h*A-p*d,g=Math.sqrt(h*h+d*d),f=v/g;if(Math.abs(f)<3){o=i;break}}if(o!==!1){var y=addPoint(e.x,e.y);y.setAttr("count",this.getAttr("count")),n.splice(o+2,0,e.x,e.y),lines[this.getAttr("count")].points.splice(o/2+1,0,y),lines[this.getAttr("count")].line.setAttrs({points:n});for(var i=0;i<lines[this.getAttr("count")].points.length;i++)lines[this.getAttr("count")].points[i].setAttr("count_point",i);line_move=this.getAttr("count"),point_move=o/2+1}}),i.setAttr("count",count),layer.add(i);var r=addPoint(t?t.x:n.x,t?t.y:n.y,e);r.setAttr("count",count),r.setAttr("count_point",0);var s=addPoint(n.x,n.y);s.setAttr("count",count),s.setAttr("count_point",1),point_move=1,layer.draw(),lines[count]={line:i,points:[r,s]},line_move=count,beforeUnloader=!0,count++}function addPoint(t,e,n){var o=new Konva.Circle({x:t,y:e,radius:5,fill:"white",stroke:"black",strokeWidth:1,with_el:n?n:!1});return o.on("mouseleave",function(){layer.setZIndex(999999);for(var t=lines[this.getAttr("count")].points,e=t.length,n=0;e>n;n++)t[n].setAttrs({fill:"transparent",stroke:"transparent"});layer.draw()}),o.on("mouseenter",function(){layer.setZIndex(999999);for(var t=lines[this.getAttr("count")].points,e=t.length,n=0;e>n;n++)t[n].setAttrs({fill:"white",stroke:"black"});layer.draw()}),o.on("mousedown touchstart",function(t){if(line_move=this.getAttr("count"),point_move=this.getAttr("count_point"),layer.setZIndex(999999),2==t.evt.button&&lines[line_move].points.length>2)return line_number=this.getAttr("count"),void pointMenu(line_move,point_move);if(this.getAttr("with_el")){var e=elements[this.getAttr("with_el").el].el.getAttr("lines");e.splice(e.indexOf(line_move),1),elements[this.getAttr("with_el").el].el.setAttr("lines",e)}this.setAttr("with_el",!1)}),layer.add(o),beforeUnloader=!0,o}